<%{
	// Check user profile and filter applications accordingly
	input.profile = thisapp.portal.loginUserProfile();
	input.currentUser = zoho.loginuser;
	// Fetch applications based on user type
	if(input.profile == "Active Agent")
	{
		// For agents: show only their assigned applications
		applicationsList = Application_Form[Application_Owner == input.currentUser];
	}
	else
	{
		// For others: show all applications  
		applicationsList = Application_Form[ID != null];
	}
	%>
<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>All Applications - AGC</title>
</head>

<style>
	@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
	
	body {
		margin: 0;
		font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
		background: #f8f9fa;
		font-size: 14px;
		line-height: 1.5;
		color: #333333;
	}
	
	.page-header {
		background: linear-gradient(135deg, #113e68 0%, #0d2f4f 100%);
		color: white;
		padding: 30px 0;
		margin-bottom: 30px;
		box-shadow: 0 4px 20px rgba(17, 62, 104, 0.3);
	}
	
	.page-header .container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 0 30px;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	
	.page-title {
		display: flex;
		align-items: center;
		gap: 15px;
	}
	
	.page-title h1 {
		font-size: 28px;
		font-weight: 800;
		margin: 0;
	}
	
	.page-title .icon {
		width: 50px;
		height: 50px;
		background: rgba(255, 255, 255, 0.2);
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 20px;
	}
	
	.page-stats {
		display: flex;
		gap: 30px;
		align-items: center;
	}
	
	.stat-item {
		text-align: center;
	}
	
	.stat-number {
		font-size: 24px;
		font-weight: 800;
		display: block;
	}
	
	.stat-label {
		font-size: 12px;
		opacity: 0.8;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}
	
	.content-container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 0 30px;
	}
	
	.search-section {
		background: white;
		border-radius: 16px;
		padding: 25px;
		margin-bottom: 25px;
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
		border: 1px solid #e0e0e0;
	}
	
	.search-container {
		position: relative;
		max-width: 600px;
		margin: 0 auto;
	}
	
	.search-input {
		width: 100%;
		padding: 16px 50px 16px 20px;
		border: 2px solid #e9ecef;
		border-radius: 12px;
		font-size: 16px;
		font-family: 'Inter', sans-serif;
		transition: all 0.3s ease;
		background: #f8f9fa;
	}
	
	.search-input:focus {
		outline: none;
		border-color: #113e68;
		background: white;
		box-shadow: 0 0 0 3px rgba(17, 62, 104, 0.1);
	}
	
	.search-icon {
		position: absolute;
		right: 18px;
		top: 50%;
		transform: translateY(-50%);
		color: #6c757d;
		font-size: 18px;
		pointer-events: none;
	}
	
	.search-info {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-top: 15px;
		font-size: 13px;
		color: #6c757d;
	}
	
	.search-help {
		display: flex;
		align-items: center;
		gap: 5px;
	}
	
	.search-results {
		font-weight: 600;
		color: #113e68;
	}
	
	.clear-search {
		background: none;
		border: none;
		color: #113e68;
		cursor: pointer;
		font-size: 13px;
		text-decoration: underline;
		padding: 0;
	}
	
	.clear-search:hover {
		color: #0d2f4f;
	}
	
	.applications-section {
		background: white;
		border-radius: 16px;
		overflow: hidden;
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
		border: 1px solid #e0e0e0;
	}
	
	.section-header {
		background: linear-gradient(135deg, #113e68 0%, #0d2f4f 100%);
		color: white;
		padding: 20px 30px;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}
	
	.section-title {
		display: flex;
		align-items: center;
		gap: 12px;
		font-size: 16px;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.filter-info {
		font-size: 13px;
		opacity: 0.9;
		background: rgba(255, 255, 255, 0.1);
		padding: 6px 12px;
		border-radius: 20px;
	}
	
	.applications-table {
		width: 100%;
		border-collapse: collapse;
	}
	
	.applications-table th {
		background: #f8f9fa;
		padding: 18px 20px;
		text-align: left;
		font-weight: 700;
		font-size: 13px;
		color: #555;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		border-bottom: 2px solid #e9ecef;
		position: sticky;
		top: 0;
		z-index: 10;
	}
	
	.applications-table td {
		padding: 20px;
		border-bottom: 1px solid #f1f3f4;
		vertical-align: middle;
		font-size: 14px;
	}
	
	.applications-table tbody tr {
		transition: all 0.2s ease;
	}
	
	.applications-table tbody tr:hover {
		background: rgba(17, 62, 104, 0.03);
		transform: translateX(4px);
		box-shadow: 0 4px 15px rgba(17, 62, 104, 0.08);
	}
	
	.app-id-cell {
		font-family: 'Monaco', 'Consolas', monospace;
		font-size: 12px;
		color: #6c757d;
		background: #f8f9fa;
		padding: 4px 8px;
		border-radius: 4px;
		display: inline-block;
	}
	
	.student-name {
		font-weight: 600;
		color: #113e68;
		margin-bottom: 2px;
	}
	
	.student-id {
		font-size: 11px;
		color: #6c757d;
	}
	
	.program-info {
		font-weight: 600;
		color: #333;
	}
	
	.academic-info {
		display: flex;
		flex-direction: column;
		gap: 2px;
	}
	
	.year-badge {
		background: #e3f2fd;
		color: #1976d2;
		padding: 3px 8px;
		border-radius: 12px;
		font-size: 11px;
		font-weight: 600;
		display: inline-block;
		width: fit-content;
	}
	
	.semester-badge {
		background: #f3e5f5;
		color: #7b1fa2;
		padding: 3px 8px;
		border-radius: 12px;
		font-size: 11px;
		font-weight: 600;
		display: inline-block;
		width: fit-content;
		margin-top: 2px;
	}
	
	.degree-badge {
		background: #e8f5e8;
		color: #2e7d32;
		padding: 4px 10px;
		border-radius: 15px;
		font-size: 12px;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}
	
	.stage-badge {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 8px 12px;
		border-radius: 20px;
		font-size: 12px;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.3px;
		white-space: nowrap;
	}
	
	.stage-pending {
		background: rgba(255, 193, 7, 0.15);
		color: #f57c00;
		border: 1px solid rgba(255, 193, 7, 0.3);
	}
	
	.stage-approved {
		background: rgba(59, 178, 144, 0.15);
		color: #3bb290;
		border: 1px solid rgba(59, 178, 144, 0.3);
	}
	
	.stage-rejected {
		background: rgba(244, 67, 54, 0.15);
		color: #f44336;
		border: 1px solid rgba(244, 67, 54, 0.3);
	}
	
	.stage-review {
		background: rgba(156, 39, 176, 0.15);
		color: #7b1fa2;
		border: 1px solid rgba(156, 39, 176, 0.3);
	}
	
	.stage-conditional {
		background: rgba(255, 152, 0, 0.15);
		color: #f57c00;
		border: 1px solid rgba(255, 152, 0, 0.3);
	}
	
	.stage-complete {
		background: rgba(59, 178, 144, 0.15);
		color: #3bb290;
		border: 1px solid rgba(59, 178, 144, 0.3);
	}
	
	.stage-missing {
		background: rgba(255, 152, 0, 0.15);
		color: #ff9800;
		border: 1px solid rgba(255, 152, 0, 0.3);
	}
	
	.actions-cell {
		text-align: center;
	}
	
	.view-btn {
		background: linear-gradient(135deg, #113e68, #0d2f4f);
		color: white;
		border: none;
		padding: 8px 16px;
		border-radius: 8px;
		font-size: 12px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.3s ease;
		text-decoration: none;
		display: inline-flex;
		align-items: center;
		gap: 6px;
		box-shadow: 0 2px 8px rgba(17, 62, 104, 0.2);
	}
	
	.view-btn:hover {
		background: linear-gradient(135deg, #0d2f4f, #0a2640);
		transform: translateY(-2px);
		box-shadow: 0 6px 20px rgba(17, 62, 104, 0.3);
		color: white;
		text-decoration: none;
	}
	
	.no-applications {
		text-align: center;
		padding: 80px 40px;
		color: #6c757d;
	}
	
	.no-applications i {
		font-size: 64px;
		color: #dee2e6;
		margin-bottom: 20px;
	}
	
	.no-applications h3 {
		color: #495057;
		margin-bottom: 10px;
		font-size: 20px;
	}
	
	.no-applications p {
		margin: 0;
		font-size: 14px;
	}
	
	.back-button {
		background: #6c757d;
		color: white;
		border: none;
		padding: 12px 24px;
		border-radius: 8px;
		font-size: 14px;
		font-weight: 600;
		cursor: pointer;
		transition: all 0.3s ease;
		display: inline-flex;
		align-items: center;
		gap: 8px;
		text-decoration: none;
		margin-bottom: 20px;
	}
	
	.back-button:hover {
		background: #5a6268;
		transform: translateY(-1px);
		color: white;
		text-decoration: none;
	}
	
	.no-results {
		text-align: center;
		padding: 60px 40px;
		color: #6c757d;
		display: none;
	}
	
	.no-results i {
		font-size: 48px;
		color: #dee2e6;
		margin-bottom: 15px;
	}
	
	.no-results h3 {
		color: #495057;
		margin-bottom: 8px;
		font-size: 18px;
	}
	
	.no-results p {
		margin: 0;
		font-size: 14px;
	}
	
	@media (max-width: 1200px) {
		.page-header .container {
			flex-direction: column;
			gap: 20px;
			text-align: center;
		}
		
		.page-stats {
			justify-content: center;
		}
		
		.applications-table {
			font-size: 12px;
		}
		
		.applications-table th,
		.applications-table td {
			padding: 12px 8px;
		}
	}
	
	@media (max-width: 768px) {
		.content-container {
			padding: 0 15px;
		}
		
		.search-section {
			padding: 20px 15px;
		}
		
		.search-info {
			flex-direction: column;
			gap: 10px;
			text-align: center;
		}
		
		.applications-table th:nth-child(4),
		.applications-table td:nth-child(4),
		.applications-table th:nth-child(5),
		.applications-table td:nth-child(5) {
			display: none;
		}
	}
</style>

<body>
	<div class="page-header">
		<div class="container">
			<div class="page-title">
				<div class="icon">
					<i class="fas fa-file-alt"></i>
				</div>
				<div>
					<h1>All Applications</h1>
					<p style="margin: 0; opacity: 0.8; font-size: 14px;">
						<%=if(input.profile == "Active Agent","Your assigned applications","Complete applications overview")%>
					</p>
				</div>
			</div>
			<div class="page-stats">
				<div class="stat-item">
					<span class="stat-number" id="totalCount"><%=applicationsList.count()%></span>
					<span class="stat-label">Total Applications</span>
				</div>
<%
	pendingCount = 0;
	approvedCount = 0;
	for each  app in applicationsList
	{
		if(app.Application_Stage.contains("Pending") || app.Application_Stage.contains("Review"))
		{
			pendingCount = pendingCount + 1;
		}
		if(app.Application_Stage.contains("Acceptance") || app.Application_Stage.contains("Complete"))
		{
			approvedCount = approvedCount + 1;
		}
	}
	%>
<div class="stat-item">
					<span class="stat-number" id="pendingCount"><%=pendingCount%></span>
					<span class="stat-label">Pending Review</span>
				</div>
				<div class="stat-item">
					<span class="stat-number" id="approvedCount"><%=approvedCount%></span>
					<span class="stat-label">Approved</span>
				</div>
			</div>
		</div>
	</div>

	<div class="content-container">
		<a href="#" class="back-button" onclick="history.back()">
			<i class="fas fa-arrow-left"></i> Back to Dashboard
		</a>
		
		<!-- Search Section -->
		<div class="search-section">
			<div class="search-container">
				<input type="text" 
					   id="searchInput" 
					   class="search-input" 
					   placeholder="Search by Student Name, App ID, Passport, Program, or Stage..."
					   autocomplete="off"
					   oninput="filterApplications(this.value)"
					   onkeyup="filterApplications(this.value)"
					   onpaste="setTimeout(function(){filterApplications(document.getElementById('searchInput').value)}, 100)">
				<i class="fas fa-search search-icon"></i>
			</div>
			<div class="search-info">
				<div class="search-help">
					<i class="fas fa-info-circle"></i>
					<span>Search across all fields including Student Name, App ID, Passport, Program, and Application Stage</span>
				</div>
				<div style="display: flex; gap: 15px; align-items: center;">
					<span class="search-results" id="searchResults">Showing <%=applicationsList.count()%> applications</span>
					<button class="clear-search" id="clearSearch" onclick="clearSearch()" style="display: none;">Clear Search</button>
				</div>
			</div>
		</div>
		
		<div class="applications-section">
			<div class="section-header">
				<div class="section-title">
					<i class="fas fa-list"></i>
					Applications Report
				</div>
				<div class="filter-info">
					<%=if(input.profile == "Active Agent","Filtered by: Your assignments","Showing: All applications")%>
				</div>
			</div>
<%
	if(applicationsList.count() > 0)
	{
		%>
<table class="applications-table" id="applicationsTable">
				<thead>
					<tr>
						<th>App ID</th>
						<th>Full Name</th>
						<th>Program</th>
						<th>Academic Year</th>
						<th>Semester</th>
						<th>Degree</th>
						<th>Stage</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
<%
		counter = 1;
		for each  app in applicationsList
		{
			studentName = if(app.Student_Application != null,app.Student_Application.Full_Name,"N/A");
			studentID = if(app.Student_Application != null,app.Student_Application.ID,"N/A");
			studentPassport = if(app.Student_Application != null,app.Student_Application.Passport_No,"N/A");
			programName = if(app.Application_Program != null,app.Application_Program.Program_Name,"N/A");
			input.degree = if(app.Degree != null,app.Degree,"N/A");
			yearName = if(app.Application_Academic_Year != null,app.Application_Academic_Year.Academic_Year,"N/A");
			semesterName = if(app.Application_Semester != null,app.Application_Semester.Semester_Name,"N/A");
			input.stage = if(app.Application_Stage != null,app.Application_Stage,"Pending Review");
			appID = if(app.App_ID != null && app.App_ID != "",app.App_ID,"N/A");
			// Determine stage class for styling
			stageClass = "stage-pending";
			if(input.stage.contains("Acceptance") || input.stage.contains("Final"))
			{
				stageClass = "stage-approved";
			}
			else if(input.stage.contains("Paid") || input.stage.contains("Complete"))
			{
				stageClass = "stage-complete";
			}
			else if(input.stage.contains("Conditional"))
			{
				stageClass = "stage-conditional";
			}
			else if(input.stage.contains("Refused") || input.stage.contains("Invalid"))
			{
				stageClass = "stage-rejected";
			}
			else if(input.stage.contains("Review") || input.stage.contains("Awaiting"))
			{
				stageClass = "stage-review";
			}
			else if(input.stage.contains("Missing"))
			{
				stageClass = "stage-missing";
			}
			%>
<tr class="application-row" 
						data-student-name="<%=studentName%>" 
						data-app-id="<%=appID%>" 
						data-passport="<%=studentPassport%>"
						data-program="<%=programName%>" 
						data-stage="<%=input.stage%>"
						data-degree="<%=input.degree%>"
						data-year="<%=yearName%>"
						data-semester="<%=semesterName%>">
						<td>
							<span class="app-id-cell"><%=appID%></span>
						</td>
						<td>
							<div class="student-name"><%=studentName%></div>
							<div class="student-id">ID: <%=studentID%> | Passport: <%=studentPassport%></div>
						</td>
						<td>
							<div class="program-info"><%=programName%></div>
						</td>
						<td>
							<div class="academic-info">
								<span class="year-badge"><%=yearName%></span>
							</div>
						</td>
						<td>
							<div class="academic-info">
								<span class="semester-badge"><%=semesterName%></span>
							</div>
						</td>
						<td>
							<span class="degree-badge"><%=input.degree%></span>
						</td>
						<td>
							<span class="stage-badge <%=stageClass%>">
								<i class="fas fa-circle"></i>
								<%=input.stage%>
							</span>
						</td>
						<td class="actions-cell">
							<a href="
<%
			if(input.profile == "Active Agent")
			{
				%>
https://agc9mh.zohocreatorportal.com/#page:Application_Details?application_id=<%=app.ID%>
<%
			}
			else
			{
				%>
https://creatorapp.zohopublic.com/agc9mh/daxow/page-perma/Application_Details/M28OGgOdzkfyAMqq3nyJNrUaQnWVCmur4d1H8vSPaVJ51Rw6VEr7yxPqN4ye3XyS9C40hw6YmHp39OhF5JbwauPQQZOtmKz51Vvd?application_id=<%=app.ID%>
<%
			}
			%>
"class="view-btn">
								<i class="fas fa-eye"></i>
								View
							</a>
						</td>
					</tr>
<%
		}
		%>
</tbody>
			</table>
			
			<!-- No Search Results Message -->
			<div class="no-results" id="noResults">
				<i class="fas fa-search"></i>
				<h3>No applications found</h3>
				<p>Try adjusting your search terms or clear the search to see all applications</p>
			</div>
<%
	}
	else
	{
		%>
<div class="no-applications">
				<i class="fas fa-file-alt"></i>
				<h3>No Applications Found</h3>
				<p><%=if(input.profile == "Active Agent","You don't have any assigned applications yet.","No applications have been submitted yet.")%></p>
			</div>
<%
	}
	%>
</div>
	</div>

	<script>
		// Global variables
		var totalApplications = <%=applicationsList.count()%>;
		var currentSearchTerm = '';
		
		// Main filter function - called directly from HTML events
		function filterApplications(searchTerm) {
			if (typeof searchTerm !== 'string') searchTerm = '';
			searchTerm = searchTerm.toLowerCase().trim();
			currentSearchTerm = searchTerm;
			
			var rows = document.querySelectorAll('.application-row');
			var visibleCount = 0;
			
			if (searchTerm === '') {
				// Show all rows
				for (var i = 0; i < rows.length; i++) {
					rows[i].style.display = '';
				}
				visibleCount = totalApplications;
				showClearButton(false);
				showNoResults(false);
			} else {
				// Filter rows
				for (var i = 0; i < rows.length; i++) {
					var row = rows[i];
					var studentName = (row.getAttribute('data-student-name') || '').toLowerCase();
					var appId = (row.getAttribute('data-app-id') || '').toLowerCase();
					var passport = (row.getAttribute('data-passport') || '').toLowerCase();
					var program = (row.getAttribute('data-program') || '').toLowerCase();
					var stage = (row.getAttribute('data-stage') || '').toLowerCase();
					var degree = (row.getAttribute('data-degree') || '').toLowerCase();
					var year = (row.getAttribute('data-year') || '').toLowerCase();
					var semester = (row.getAttribute('data-semester') || '').toLowerCase();
					
					// Check if search term exists in any of the fields
					if (studentName.indexOf(searchTerm) !== -1 || 
						appId.indexOf(searchTerm) !== -1 || 
						passport.indexOf(searchTerm) !== -1 ||
						program.indexOf(searchTerm) !== -1 || 
						stage.indexOf(searchTerm) !== -1 ||
						degree.indexOf(searchTerm) !== -1 ||
						year.indexOf(searchTerm) !== -1 ||
						semester.indexOf(searchTerm) !== -1) {
						row.style.display = '';
						visibleCount++;
					} else {
						row.style.display = 'none';
					}
				}
				showClearButton(true);
				showNoResults(visibleCount === 0);
			}
			
			// Update search results count
			updateResultsCount(searchTerm, visibleCount);
		}
		
		function updateResultsCount(searchTerm, visibleCount) {
			var searchResults = document.getElementById('searchResults');
			if (searchResults) {
				if (searchTerm === '') {
					searchResults.textContent = 'Showing ' + totalApplications + 'applications';
				} else {
					searchResults.textContent = 'Found ' + visibleCount + 'of ' + totalApplications + 'applications';
				}
			}
		}
		
		function showClearButton(show) {
			var clearBtn = document.getElementById('clearSearch');
			if (clearBtn) {
				clearBtn.style.display = show ? 'inline' : 'none';
			}
		}
		
		function showNoResults(show) {
			var noResults = document.getElementById('noResults');
			var applicationsTable = document.getElementById('applicationsTable');
			
			if (noResults && applicationsTable) {
				if (show) {
					applicationsTable.style.display = 'none';
					noResults.style.display = 'block';
				} else {
					applicationsTable.style.display = 'table';
					noResults.style.display = 'none';
				}
			}
		}
		
		function clearSearch() {
			var searchInput = document.getElementById('searchInput');
			if (searchInput) {
				searchInput.value = '';
				filterApplications('');
				searchInput.focus();
			}
		}
		
		// Simple initialization when page loads
		setTimeout(function() {
			var searchInput = document.getElementById('searchInput');
			if (searchInput) {
				searchInput.focus();
			}
		}, 500);
		
		console.log('All Applications page with search loaded');
		console.log('User profile: <%=input.profile%>');
		console.log('Total applications: <%=applicationsList.count()%>');
	</script>
</body>
</html>
<%

}%>
